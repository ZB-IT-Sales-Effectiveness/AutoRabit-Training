<html>
<head>
<script src="/soap/ajax/10.0/connection.js" type="text/javascript"></script>
<script language="javascript">

//get passed parameters



var qsParm = new Array();
var userId = "{!$User.Id}";

function qs() {
var query = window.location.search.substring(1);
var parms = query.split('&');

for (var i=0; i<parms.length; i++) {
var pos = parms[i].indexOf('=');

if (pos > 0) {
var key = parms[i].substring(0,pos);
var val = parms[i].substring(pos+1);
qsParm[key] = val;
}

}
}

function getIdOfLatestAttachment(id) {
var attachmentId = null;


var result = sforce.connection.query("Select a.ParentId, a.Name, a.Id, a.CreatedDate From Attachment a " + 
"where createdById = '" + userId + "'" + " and parentId = '" + id + "' order by CreatedDate desc limit 1");

var records = result.getArray("records");


if (records.length > 0) {
var record = records[0];
attachmentId = record.Id;
}

return attachmentId;
}

qsParm['eid'] = null;
var pictureId = null;
var entityId = null;

//query the queryString
qs();



//now associate the contact record with the picture
if (qsParm['eid']) {
entityId = qsParm['eid'];
//document.write('Operating On' + entityId);

pictureId = getIdOfLatestAttachment(entityId)

//document.write('Picture Id ' + pictureId);

var gplProfile = new sforce.SObject("GPL_Profile__c");
gplProfile.id = entityId;
//GPL_Profile__c.btydev__Picture_Id__c = pictureId;
gplProfile.Picture_Id__c = pictureId;
var result = sforce.connection.update([gplProfile]);

/*
if (result[0].getBoolean("success")) {
//document.write("item with id " + result[0].id + " updated");
//parent.window.location.href = "/" + entityId;
parent.window.location.href = "/apex/SurgeonPortalView?id=" + entityId;

} else {
document.write("failed to update item: " + result[0]);
parent.window.location.href = "/apex/SurgeonPortalView?id=" + entityId;
}

*/

}

//parent.window.location.href = "/" + entityId;
var str=parent.location.href; 
if(str.indexOf('/sp/')!=-1) 
{ 
parent.window.location.href = "/sp/apex/SurgeonPortalView?id=" + entityId;
}
else
{
parent.window.location.href = "/apex/SurgeonPortalView?id=" + entityId;
}


</script>
</head>



</html>